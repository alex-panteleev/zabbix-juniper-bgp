zabbix_export:
  version: '6.0'
  date: '2023-05-17T12:53:37Z'
  groups:
    -
      uuid: 57b7ae836ca64446ba2c296389c009b7
      name: Templates/Modules
  templates:
    -
      uuid: ce5be3cdd7ba4182b50707a91f93722c
      template: 'Juniper BGP'
      name: 'Juniper BGP'
      groups:
        -
          name: Templates/Modules
      discovery_rules:
        -
          uuid: 936ecc9d7f01483f9f7c089944837cce
          name: 'BGP peer discovery'
          type: SNMP_AGENT
          snmp_oid: 'discovery[{#BGPPEERINDEX},.1.3.6.1.4.1.2636.5.1.1.2.1.1.1.14,{#BGPPEERREMOTEADDRESS},1.3.6.1.4.1.2636.5.1.1.2.1.1.1.11,{#BGPPEERREMOTEAS},.1.3.6.1.4.1.2636.5.1.1.2.1.1.1.13,{#BGPPEERREMOTEADDRTYPE},1.3.6.1.4.1.2636.5.1.1.2.1.1.1.10]'
          key: net.bgp.peer.discovery
          delay: 10m
          item_prototypes:
            -
              uuid: cf26fed5043d4c6d91860e22c7fa1f0c
              name: 'Last received error ({#BGPPEERREMOTEADDRESS}, AS{#BGPPEERREMOTEAS})'
              type: SNMP_AGENT
              snmp_oid: '.1.3.6.1.4.1.2636.5.1.1.2.2.1.1.5.{#SNMPINDEX}'
              key: 'net.bgp.peer.error.received[{#BGPPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}]'
              delay: 5m
              trends: '0'
              value_type: TEXT
              tags:
                -
                  tag: Application
                  value: BGP
            -
              uuid: 2ac21ab81d444df0a7ab05a37c57b84b
              name: 'Last sent error ({#BGPPEERREMOTEADDRESS}, AS{#BGPPEERREMOTEAS})'
              type: SNMP_AGENT
              snmp_oid: '.1.3.6.1.4.1.2636.5.1.1.2.2.1.1.6.{#SNMPINDEX}'
              key: 'net.bgp.peer.error.sent[{#BGPPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}]'
              delay: 5m
              trends: '0'
              value_type: TEXT
              tags:
                -
                  tag: Application
                  value: BGP
            -
              uuid: 493cd5481e454f0baa76dda7d0c74e72
              name: 'Prefixes accepted ({#BGPPEERREMOTEADDRESS}, AS{#BGPPEERREMOTEAS})'
              type: SNMP_AGENT
              snmp_oid: '1.3.6.1.4.1.2636.5.1.1.2.6.2.1.8.{#BGPPEERINDEX}.{#BGPPEERREMOTEADDRTYPE}.1'
              key: 'net.bgp.peer.prefixes.accepted[{#BGPPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}]'
              delay: 2m
              tags:
                -
                  tag: Application
                  value: BGP
            -
              uuid: 5b24efd96e3448a999523b663d2b6334
              name: 'Prefixes advertised ({#BGPPEERREMOTEADDRESS}, AS{#BGPPEERREMOTEAS})'
              type: SNMP_AGENT
              snmp_oid: '.1.3.6.1.4.1.2636.5.1.1.2.6.2.1.10.{#BGPPEERINDEX}.{#BGPPEERREMOTEADDRTYPE}.1'
              key: 'net.bgp.peer.prefixes.advertised[{#BGPPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}]'
              delay: 2m
              tags:
                -
                  tag: Application
                  value: BGP
            -
              uuid: 136955318dab4bb3b2edfb7365d5c3b3
              name: 'Prefixes received ({#BGPPEERREMOTEADDRESS}, AS{#BGPPEERREMOTEAS})'
              type: SNMP_AGENT
              snmp_oid: '1.3.6.1.4.1.2636.5.1.1.2.6.2.1.7.{#BGPPEERINDEX}.{#BGPPEERREMOTEADDRTYPE}.1'
              key: 'net.bgp.peer.prefixes.received[{#BGPPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}]'
              delay: 2m
              tags:
                -
                  tag: Application
                  value: BGP
            -
              uuid: 11bce27f8d094e319f153fe26e676aec
              name: 'Prefixes rejected ({#BGPPEERREMOTEADDRESS}, AS{#BGPPEERREMOTEAS})'
              type: SNMP_AGENT
              snmp_oid: '1.3.6.1.4.1.2636.5.1.1.2.6.2.1.9.{#BGPPEERINDEX}.{#BGPPEERREMOTEADDRTYPE}.1'
              key: 'net.bgp.peer.prefixes.rejected[{#BGPPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}]'
              delay: 2m
              tags:
                -
                  tag: Application
                  value: BGP
            -
              uuid: 9e58859360ff4d9ea89949ad8c3daffd
              name: 'Peer state ({#BGPPEERREMOTEADDRESS}, AS{#BGPPEERREMOTEAS})'
              type: SNMP_AGENT
              snmp_oid: '.1.3.6.1.4.1.2636.5.1.1.2.1.1.1.2.{#SNMPINDEX}'
              key: 'net.bgp.peer.state[{#BGPPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}]'
              valuemap:
                name: BgpPeerState
              tags:
                -
                  tag: Application
                  value: BGP
            -
              uuid: 444a83765d5a4cce8209d607758eeda9
              name: 'Administrative status ({#BGPPEERREMOTEADDRESS}, AS{#BGPPEERREMOTEAS})'
              type: SNMP_AGENT
              snmp_oid: '.1.3.6.1.4.1.2636.5.1.1.2.1.1.1.3.{#SNMPINDEX}'
              key: 'net.bgp.peer.status[{#BGPPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}]'
              delay: 5m
              valuemap:
                name: BgpPeerAdminStatus
              tags:
                -
                  tag: Application
                  value: BGP
            -
              uuid: 9a93e17ab9584849a091128ced6032bb
              name: 'Established time ({#BGPPEERREMOTEADDRESS}, AS{#BGPPEERREMOTEAS})'
              type: SNMP_AGENT
              snmp_oid: '.1.3.6.1.4.1.2636.5.1.1.2.4.1.1.1.{#SNMPINDEX}'
              key: 'net.bgp.peer.uptime[{#BGPPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}]'
              delay: 5m
              units: s
              tags:
                -
                  tag: Application
                  value: BGP
          trigger_prototypes:
            -
              uuid: cba67930e58f4a65959c4ec32d53afe2
              expression: 'last(/Juniper BGP/net.bgp.peer.state[{#BGPPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}])=6 and last(/Juniper BGP/net.bgp.peer.prefixes.received[{#BGPPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}])<(1-{$PREFIXES_CRIT_LOST}/100)*avg(/Juniper BGP/net.bgp.peer.prefixes.received[{#BGPPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}],1d)'
              name: 'BGP peer {#BGPPEERREMOTEADDRESS} (AS{#BGPPEERREMOTEAS}) has lost more than {$PREFIXES_CRIT_LOST}% of received prefixes'
              priority: WARNING
              dependencies:
                -
                  name: 'BGP peer {#BGPPEERREMOTEADDRESS} (AS{#BGPPEERREMOTEAS}) is DOWN'
                  expression: 'last(/Juniper BGP/net.bgp.peer.state[{#BGPPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}],#3)<>6 and last(/Juniper BGP/net.bgp.peer.status[{#BGPPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}])=2'
            -
              uuid: 0e64335839324875b37c46be32c5188a
              expression: 'last(/Juniper BGP/net.bgp.peer.state[{#BGPPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}],#3)<>6 and last(/Juniper BGP/net.bgp.peer.status[{#BGPPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}])=2'
              name: 'BGP peer {#BGPPEERREMOTEADDRESS} (AS{#BGPPEERREMOTEAS}) is DOWN'
              priority: HIGH
          graph_prototypes:
            -
              uuid: 36ba6474bf674df391d2902012cf0152
              name: 'Peer {#BGPPEERREMOTEADDRESS} (AS{#BGPPEERREMOTEAS}) prefixes exchange'
              graph_items:
                -
                  drawtype: GRADIENT_LINE
                  color: 00FF00
                  calc_fnc: MIN
                  item:
                    host: 'Juniper BGP'
                    key: 'net.bgp.peer.prefixes.received[{#BGPPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}]'
                -
                  sortorder: '1'
                  drawtype: GRADIENT_LINE
                  color: 00BFFF
                  calc_fnc: MIN
                  item:
                    host: 'Juniper BGP'
                    key: 'net.bgp.peer.prefixes.advertised[{#BGPPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}]'
                -
                  sortorder: '2'
                  color: 00FFBF
                  calc_fnc: MIN
                  item:
                    host: 'Juniper BGP'
                    key: 'net.bgp.peer.prefixes.accepted[{#BGPPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}]'
                -
                  sortorder: '3'
                  color: E91E63
                  calc_fnc: MIN
                  item:
                    host: 'Juniper BGP'
                    key: 'net.bgp.peer.prefixes.rejected[{#BGPPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}]'
          preprocessing:
            -
              type: JAVASCRIPT
              parameters:
                - |
                  json = JSON.parse(value);
                  
                  json.forEach(function (item, index, array) {
                      var ip = item["{#BGPPEERREMOTEADDRESS}"];
                  
                      parts = ip.trim().split(' ');
                  
                      if (parts.length === 4) {
                          for (var i = 0; i < parts.length; ++i) {
                              parts[i] = parseInt(parts[i], 16);
                          }
                  
                          ip = parts.join('.');
                      } else {
                          var str = parts.join('');
                          var parts = str.match(/.{1,4}/g);
                          ip = parts.join(":");
                          ip = ip.replace(/\b(?:0+:){2,}/, ':')
                                 .split(':')
                           .map(function(octet) {
                                     return  octet.replace(/\b0+/g, '');
                                 })
                                 .join(':')
                                 .toLowerCase();
                      }
                  
                      array[index]["{#BGPPEERREMOTEADDRESS}"] = ip;
                  });
                  
                  return JSON.stringify(json);
      macros:
        -
          macro: '{$PREFIXES_CRIT_LOST}'
          value: '20'
          description: 'Critical percentage of the decrease in the number of prefixes for the last day.'
      valuemaps:
        -
          uuid: 231f045ed42e423292ed58e0da97e2f0
          name: BgpPeerAdminStatus
          mappings:
            -
              value: '1'
              newvalue: stop
            -
              value: '2'
              newvalue: start
        -
          uuid: 2026d1a39e474ceda6bf1ee973e7b761
          name: BgpPeerState
          mappings:
            -
              value: '1'
              newvalue: idle
            -
              value: '2'
              newvalue: connect
            -
              value: '3'
              newvalue: active
            -
              value: '4'
              newvalue: opensent
            -
              value: '5'
              newvalue: openconfirm
            -
              value: '6'
              newvalue: established
